import * as changeCase from "change-case";
import * as inquirer from "inquirer";
import * as fs from "fs";
import {PermissionController} from "./scripts/controllers/PermissionController";
import {GenerateController} from "./scripts/controllers/GenerateController";
import {MANIFEST_PATH} from "./scripts/constants/ManifestPath";
import {DependencyController} from "./scripts/controllers/DependencyController";
import {PackageManager} from "./scripts/utils/PackageManager";
// import * as pkg from "./scripts/constants/Package";


const chalk = require('chalk'),
    figlet = require('figlet'),
    commander = require('commander'),
    pkg = require('./package.json');

commander.arguments('<name>')
    .version(pkg.version)
    .option('-g, --generate [name]', 'component (e.g activity, fragment etc..)')
    .option('-p, --permission <permission>', 'add uses-permission to manifest file(e.g INTERNET)')
    .option('-d, --dependency <dependency>', 'add dependency to build.gradle and sync gradle')
    .action((name: string) => {
        if (commander.generate) {
            const generateController: GenerateController = new GenerateController();
            console.log(chalk.yellow(`${changeCase.pascalCase(commander.generate)} will generated by Android CLI`));
            PackageManager.getApplicationPackage(packageName => {
                PackageManager.getPackages(packageName, packageList => {
                    let questions = [{
                        type: 'list',
                        name: 'package',
                        message: "Choose your target package path",
                        choices: packageList,
                    }];
                    inquirer.prompt(questions).then(answers => {
                        generateController.generateRenderedOutFile(commander.generate, name, answers.package);
                    });
                })
            })
        }
    }).parse(process.argv);

presentInitialMessage();

if (commander.permission) {
    const permissionController: PermissionController = new PermissionController();
    permissionController.addPermissionToManifest(commander.permission, xml => {
        try {
            fs.writeFileSync(MANIFEST_PATH, xml);
            console.log(chalk.green(`Successful adding permission`));
        } catch (err) {
            console.log(chalk.red(`Failed to adding permission`));
            console.log(chalk.red(err))
        }
    });
} else if (commander.dependency) {
    const dependencyController: DependencyController = new DependencyController();
    dependencyController.addDependency(commander.dependency, (code, stdout, stderr) => {
        if (stderr) {
            console.log(chalk.red(`Complete with some error. Please check gradle sync result.`));
        } else {
            console.log(chalk.green(`Successful adding dependency with gradle sync`));
        }
    });
}

/**
 * @desc Just present initial message
 */
function presentInitialMessage() {
    console.log(chalk.cyan("WELCOME TO ANDROID CLI!"));
}
